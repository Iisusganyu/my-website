<?php
// init-db-with-movies.php
// Включаем отображение ошибок
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Заголовки для JSON
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Подключение к базе данных
$host = 'localhost';
$dbname = 'movie_store_db';
$username = 'root';
$password = '';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $pdo->exec("SET NAMES utf8mb4");
    
    echo "<h2>Инициализация базы данных фильмов</h2>";
    
    // 1. Проверяем существование таблицы movies
    $tables = $pdo->query("SHOW TABLES LIKE 'movies'")->fetchAll();
    
    if (empty($tables)) {
        echo "<p style='color: red;'>❌ Таблица movies не существует!</p>";
        echo "<p>Сначала создайте таблицу movies командой:</p>";
        echo "<pre>";
        echo "CREATE TABLE movies (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL DEFAULT 499.00,
    image_url VARCHAR(500),
    genre VARCHAR(100),
    director VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);";
        echo "</pre>";
        exit();
    }
    
    echo "<p style='color: green;'>✅ Таблица movies существует</p>";
    
    // 2. Проверяем, есть ли уже фильмы
    $movieCount = $pdo->query("SELECT COUNT(*) FROM movies")->fetchColumn();
    echo "<p>Текущее количество фильмов в базе: <strong>$movieCount</strong></p>";
    
    // 3. Данные фильмов
    $movies = [
        [1, 'Голодные игры', 'Будущее. Деспотичное государство ежегодно устраивает показательные игры на выживание, за которыми в прямом эфире следят весь мир. В этот раз участвовать будут юная Китнисс и тайно влюбленный в нее Пит. Они знакомы с детства, но теперь должны стать врагами. Ведь по нерушимому закону Голодных игр победить может только один из 24 участников. Судьям не важно, кто выиграет, главное — зрелище. И на этот раз зрелище будет незабываемым…', 499.00, 'images/poster1.jpg', 'Фантастика, Боевик, Приключения, Триллер', 'Гэри Росс'],
        [2, 'Меню', 'Элитная пара отправляется на удаленный остров, чтобы поужинать в эксклюзивном ресторане шеф-повара, но вскоре понимает, что меню этого ужина содержит шокирующие сюрпризы.', 499.00, 'images/poster2.jpg', 'Комедия, Триллер', 'Марк Майлод'],
        [3, 'Его три дочери', 'Драматическая история о взаимоотношениях отца и его трех дочерей, переживающих сложные времена в семье.', 599.00, 'images/poster3.jpg', 'Драма', 'Азазель Джейкобс'],
        [4, 'Дьявол носит прада', 'Юная журналистка устраивается на работу помощницей к властной и требовательной главной редактрисе модного журнала и оказывается в водовороте мира высокой моды и жесткой конкуренции.', 399.00, 'images/poster4.jpg', 'Драма, Комедия', 'Дэвид Фрэнкел'],
        [5, 'Крик', 'По городу прокатилась волна жестоких убийств, жертвами становятся беззащитные люди. Новой жертвой телефонного маньяка из городка Вудсборо может стать ещё одна девушка — Сидни Прескотт.', 399.00, 'images/poster5.jpg', 'Ужасы, Триллер, Детектив', 'Уэс Крэйвен'],
        [6, 'Опасная игра Слоун', 'Элизабет Слоун — самый востребованный и рисковый лоббист политического бизнеса США. Ловко ведя психологические игры и используя искусство манипуляции, она сражает оппонентов своей непредсказуемостью и никогда не проигрывает.', 599.00, 'images/poster6.jpg', 'Драма, Преступление', 'Джон Мэдден'],
        [7, 'Интерстеллар', 'Когда засуха, пыльные бури и вымирание растений приводят человечество к продовольственному кризису, коллектив исследователей и учёных отправляется сквозь червоточину в путешествие, чтобы превзойти прежние ограничения для космических путешествий человека и найти планету с подходящими для человечества условиями.', 499.00, 'images/poster7.jpg', 'Фантастика, Драма, Приключения', 'Кристофер Нолан'],
        [8, 'Богемская рапсодия', 'Чествование группы Queen, их музыки и их выдающегося вокалиста Фредди Меркьюри, который бросил вызов стереотипам и победил условности, чтобы стать одним из самых любимых артистов на планете.', 499.00, 'images/poster8.jpg', 'Биография, Музыка, Драма', 'Брайан Сингер'],
        [9, 'Круэлла', 'Великобритания, 1960-е годы. Эстелла была необычным ребёнком, и особенно трудно ей было мириться со всякого рода несправедливостью. Вылетев из очередной школы, она с мамой отправляется в Лондон.', 599.00, 'images/poster9.jpg', 'Комедия, Криминал, Драма', 'Крэйг Гиллеспи'],
        [10, 'Дом Gucci', 'Милан, 1978 год. Девушка из небогатой семьи Патриция Реджани на вечеринке знакомится с Маурицио Гуччи, нерешительным наследником знаменитого модного дома.', 399.00, 'images/poster10.jpg', 'Биография, Драма, Криминал, Триллер', 'Ридли Скотт'],
        [11, 'Вечность', 'Когда Джоан умирает, её душа попадает в загробный мир и оказывается перед сложным выбором — у неё есть неделя, чтобы решить, с кем и где она проведёт вечность.', 399.00, 'images/poster11.jpg', 'Фэнтези, Драма, Мелодрама, Комедия', 'Дэвид Фрейн'],
        [12, 'Это всё Агата', 'Околдованная Агата Харкнесс вновь обретает свободу благодаря помощи подростка. Заинтригованная его мольбой, она отправляется на "Дорожные испытания ведьм", чтобы вернуть себе силы и выяснить мотивы своего освободителя.', 599.00, 'images/poster12.jpg', 'Фантастика, Боевик, Драма, Комедия', 'Рэйчел Голдберг, Ганджа Монтейру, Жаклин Шеффер'],
        [13, 'Дивергент', 'В антиутопическом Чикаго будущего общество разделено на пять фракций. Юная Беатрис оказывается угрозой для всей сложившейся системы, когда тесты выявляют в ней дивергента — человека, которого невозможно однозначно определить в одну из фракций.', 399.00, 'images/poster13.jpg', 'Фантастика, Детектив, Боевик, Мелодрама', 'Нил Бёргер'],
        [14, 'Война миров Z', 'Бывший сотрудник ООН Джерри Лэйн оказывается в эпицентре эпидемии неизвестного вируса, который за считанные секунды превращает людей в зомби. Пытаясь найти противоядие против вируса, Лэйн путешествует вместе со своей группой почти по всему миру.', 399.00, 'images/poster14.jpg', 'Ужасы, Фантастика, Боевик', 'Марк Форстер'],
        [15, 'Тайна 7 сестёр', 'В далеком будущем демографический бум приводит к нехватке еды, воды и жилья. Общемировое правительство принимает закон о политике одного ребенка в семье. В это тяжелое время рождаются семь девочек-близнецов, которых скрывает дедушка.', 599.00, 'images/poster15.jpg', 'Фантастика, Боевик, Триллер, Детектив', 'Томми Виркола'],
        [16, 'Доктор Стрендж в мультивселенной безумия', 'Доктор Стрэндж при помощи Вонга спасает от гигантского осьминога девушку-подростка по имени Америка Чавес, которая при сильном испуге может открывать порталы в параллельные вселенные.', 399.00, 'images/poster16.jpg', 'Фэнтези, Боевик, Приключения, Фантастика, Ужасы', 'Сэм Рэйми'],
        [17, 'Ужасающий 3', 'Пять лет назад адский клоун-маньяк Арт восстал из мёртвых, выкрал из психлечебницы Викторию и заснул. А Сиенна, проведя эти годы в специализированном учреждении, собирается встретить Рождество с семьёй тёти.', 499.00, 'images/poster17.jpg', 'Ужасы', 'Дэмиен Леоне'],
        [18, 'Пять ночей с Фредди', 'Пытаясь сохранить опекунство над сестрёнкой, Майк Шмидт устраивается работать ночным охранником в "Freddy Fazbear\'s" — некогда популярный, но ныне закрытый семейный развлекательный центр.', 399.00, 'images/poster18.jpg', 'Ужасы, Драма', 'Эмма Тамми']
    ];
    
    echo "<h3>Добавление фильмов...</h3>";
    $added = 0;
    $updated = 0;
    
    foreach ($movies as $movie) {
        $id = $movie[0];
        $title = $movie[1];
        $description = $movie[2];
        $price = $movie[3];
        $image_url = $movie[4];
        $genre = $movie[5];
        $director = $movie[6];
        
        // Проверяем, существует ли уже фильм с таким id
        $stmt = $pdo->prepare("SELECT id FROM movies WHERE id = ?");
        $stmt->execute([$id]);
        $exists = $stmt->fetch();
        
        if ($exists) {
            // Обновляем существующий фильм
            $stmt = $pdo->prepare("UPDATE movies SET title = ?, description = ?, price = ?, image_url = ?, genre = ?, director = ? WHERE id = ?");
            $stmt->execute([$title, $description, $price, $image_url, $genre, $director, $id]);
            echo "<p>✅ Обновлен: <strong>$title</strong> (ID: $id)</p>";
            $updated++;
        } else {
            // Добавляем новый фильм
            $stmt = $pdo->prepare("INSERT INTO movies (id, title, description, price, image_url, genre, director) VALUES (?, ?, ?, ?, ?, ?, ?)");
            $stmt->execute([$id, $title, $description, $price, $image_url, $genre, $director]);
            echo "<p>✅ Добавлен: <strong>$title</strong> (ID: $id)</p>";
            $added++;
        }
    }
    
    // 4. Проверяем результат
    $newCount = $pdo->query("SELECT COUNT(*) FROM movies")->fetchColumn();
    
    echo "<hr>";
    echo "<h3>Результат:</h3>";
    echo "<p style='color: green;'>✅ Операция завершена успешно!</p>";
    echo "<p>Добавлено фильмов: <strong>$added</strong></p>";
    echo "<p>Обновлено фильмов: <strong>$updated</strong></p>";
    echo "<p>Всего фильмов в базе: <strong>$newCount</strong></p>";
    
    // 5. Проверяем таблицу cart_items
    echo "<h3>Проверка таблицы cart_items...</h3>";
    $cartTables = $pdo->query("SHOW TABLES LIKE 'cart_items'")->fetchAll();
    
    if (empty($cartTables)) {
        echo "<p style='color: orange;'>⚠️ Таблица cart_items не существует</p>";
        echo "<p>Создайте таблицу командой:</p>";
        echo "<pre>";
        echo "CREATE TABLE cart_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    movie_id INT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_movie (user_id, movie_id)
);";
        echo "</pre>";
    } else {
        echo "<p style='color: green;'>✅ Таблица cart_items существует</p>";
    }
    
    echo "<hr>";
    echo "<h3>Что делать дальше:</h3>";
    echo "<ol>";
    echo "<li>Проверьте базу данных в phpMyAdmin</li>";
    echo "<li>Протестируйте регистрацию пользователей</li>";
    echo "<li>Добавьте фильмы в корзину для проверки синхронизации</li>";
    echo "</ol>";
    
    echo "<p><a href='index.html'>Вернуться на главную</a></p>";
    
} catch(PDOException $e) {
    echo "<h3 style='color: red;'>❌ Ошибка подключения к базе данных</h3>";
    echo "<p>Ошибка: " . $e->getMessage() . "</p>";
    echo "<p>Проверьте:</p>";
    echo "<ul>";
    echo "<li>Запущен ли сервер MySQL (XAMPP/WAMP/MAMP)</li>";
    echo "<li>Существует ли база данных 'movie_store_db'</li>";
    echo "<li>Правильность логина и пароля (root/пустой пароль)</li>";
    echo "</ul>";
    echo "<p>Или выполните SQL команды вручную в phpMyAdmin:</p>";
    echo "<pre>";
    echo "CREATE TABLE IF NOT EXISTS movies (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL DEFAULT 499.00,
    image_url VARCHAR(500),
    genre VARCHAR(100),
    director VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Затем вставьте фильмы вручную
";
    echo "</pre>";
}
?>